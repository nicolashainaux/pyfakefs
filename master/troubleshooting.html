
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Troubleshooting &#8212; pyfakefs 4.8.dev0 documentation</title>
    <link rel="stylesheet" href="_static/pyfakefs.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Automatically find and patch file functions and modules" href="autopatch.html" />
    <link rel="prev" title="Usage" href="usage.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="autopatch.html" title="Automatically find and patch file functions and modules"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="usage.html" title="Usage"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyfakefs 4.8.dev0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="troubleshooting">
<h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h1>
<p>This is a collection of problems with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> and possible solutions.
It will be expanded continuously based on issues and problems found by users.</p>
<div class="section" id="modules-not-working-with-pyfakefs">
<h2>Modules not working with pyfakefs<a class="headerlink" href="#modules-not-working-with-pyfakefs" title="Permalink to this headline">¶</a></h2>
<p>Modules may not work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> for several reasons. <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>
works by patching some file system related modules and functions, specifically:</p>
<ul class="simple">
<li>most file system related functions in the <code class="docutils literal notranslate"><span class="pre">os</span></code> and <code class="docutils literal notranslate"><span class="pre">os.path</span></code> modules</li>
<li>the <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> module</li>
<li>the build-in <code class="docutils literal notranslate"><span class="pre">open</span></code> function and <code class="docutils literal notranslate"><span class="pre">io.open</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">shutil.disk_usage</span></code></li>
</ul>
<p>Other file system related modules work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, because they use
exclusively these patched functions, specifically <code class="docutils literal notranslate"><span class="pre">shutil</span></code> (except for
<code class="docutils literal notranslate"><span class="pre">disk_usage</span></code>), <code class="docutils literal notranslate"><span class="pre">tempfile</span></code>, <code class="docutils literal notranslate"><span class="pre">glob</span></code> and <code class="docutils literal notranslate"><span class="pre">zipfile</span></code>.</p>
<p>A module may not work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> because of one of the following
reasons:</p>
<ul class="simple">
<li>It uses a file system related function of the mentioned modules that is
not or not correctly patched. Mostly these are functions that are seldom
used, but may be used in Python libraries (this has happened for example
with a changed implementation of <code class="docutils literal notranslate"><span class="pre">shutil</span></code> in Python 3.7). Generally,
these shall be handled in issues and we are happy to fix them.</li>
<li>It uses file system related functions in a way that will not be patched
automatically. This is the case for functions that are executed while
reading a module. This case and a possibility to make them work is
documented above under <code class="docutils literal notranslate"><span class="pre">modules_to_reload</span></code>.</li>
<li>It uses OS specific file system functions not contained in the Python
libraries. These will not work out of the box, and we generally will not
support them in <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>. If these functions are used in isolated
functions or classes, they may be patched by using the <code class="docutils literal notranslate"><span class="pre">modules_to_patch</span></code>
parameter (see the example for file locks in Django above), or by using
<code class="docutils literal notranslate"><span class="pre">unittest.patch</span></code> if you don’t need to simulate the functions. We
added some of these patches to <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, so that they are applied
automatically (currently done for some <code class="docutils literal notranslate"><span class="pre">pandas</span></code> and <code class="docutils literal notranslate"><span class="pre">Django</span></code>
functionality).</li>
<li>It uses C libraries to access the file system. There is no way no make
such a module work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>–if you want to use it, you
have to patch the whole module. In some cases, a library implemented in
Python with a similar interface already exists. An example is <code class="docutils literal notranslate"><span class="pre">lxml</span></code>,
which can be substituted with <code class="docutils literal notranslate"><span class="pre">ElementTree</span></code> in most cases for testing.</li>
</ul>
<p>A list of Python modules that are known to not work correctly with
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> will be collected here:</p>
<div class="section" id="multiprocessing-build-in">
<h3><a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a> (build-in)<a class="headerlink" href="#multiprocessing-build-in" title="Permalink to this headline">¶</a></h3>
<p>This module has several issues (related to points 1 and 3 above).
Currently there are no plans to fix this, but this may change in case of
sufficient demand.</p>
</div>
<div class="section" id="subprocess-build-in">
<h3><a class="reference external" href="https://docs.python.org/3/library/subprocess.html">subprocess</a> (build-in)<a class="headerlink" href="#subprocess-build-in" title="Permalink to this headline">¶</a></h3>
<p>This has very similar problems to <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> and cannot be used with
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> to start a process. <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> can either be mocked, if
the process is not needed for the test, or patching can be paused to start
a process if needed, and resumed afterwards
(see <a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/issues/447">this issue</a>).</p>
</div>
<div class="section" id="modules-that-rely-on-subprocess-or-multiprocessing">
<h3>Modules that rely on <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> or <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code><a class="headerlink" href="#modules-that-rely-on-subprocess-or-multiprocessing" title="Permalink to this headline">¶</a></h3>
<p>This includes a number of modules that need to start other executables to
function correctly. Examples that have shown this problem include <a class="reference external" href="https://pypi.org/project/GitPython/">GitPython</a>
and <a class="reference external" href="https://pypi.org/project/plumbum/">plumbum</a>.</p>
</div>
<div class="section" id="the-pillow-imaging-library">
<h3>The <a class="reference external" href="https://pypi.org/project/Pillow/">Pillow</a> Imaging Library<a class="headerlink" href="#the-pillow-imaging-library" title="Permalink to this headline">¶</a></h3>
<p>This library partly works with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, but it is known to not work at
least if writing JPEG files
(see <a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/issues/529">this issue</a>)</p>
</div>
<div class="section" id="the-pandas-data-analysis-toolkit">
<h3>The <a class="reference external" href="https://pypi.org/project/pandas/">pandas</a> data analysis toolkit<a class="headerlink" href="#the-pandas-data-analysis-toolkit" title="Permalink to this headline">¶</a></h3>
<p>This uses its own internal file system access written in C, thus much of
<code class="docutils literal notranslate"><span class="pre">pandas</span></code> will not work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> out of the box. Having said that,
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> patches <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to use standard file-system access instead,
so that many of the <code class="docutils literal notranslate"><span class="pre">read_xxx</span></code> functions, including <code class="docutils literal notranslate"><span class="pre">read_csv</span></code> and
<code class="docutils literal notranslate"><span class="pre">read_excel</span></code>, as well as some writer functions, do work with the fake file
system. If you use only these functions, <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> should work fine with
<code class="docutils literal notranslate"><span class="pre">pandas</span></code>.</p>
</div>
<div class="section" id="xlrd">
<h3><a class="reference external" href="https://pypi.org/project/xlrd/">xlrd</a><a class="headerlink" href="#xlrd" title="Permalink to this headline">¶</a></h3>
<p>This library is used by <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to read Excel files in the <cite>.xls</cite> format,
and can also be used stand-alone. Similar to <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, it is by default
patched by <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> to use normal file system functions that can be
patched.</p>
</div>
<div class="section" id="openpyxl">
<h3><a class="reference external" href="https://pypi.org/project/openpyxl/">openpyxl</a><a class="headerlink" href="#openpyxl" title="Permalink to this headline">¶</a></h3>
<p>This is another library that reads and writes Excel files, and is also
used by <code class="docutils literal notranslate"><span class="pre">pandas</span></code> if installed. <code class="docutils literal notranslate"><span class="pre">openpyxl</span></code> uses <code class="docutils literal notranslate"><span class="pre">lxml</span></code> for some file-system
access if it is installed–in this case <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> will not be able to patch
it correctly (<code class="docutils literal notranslate"><span class="pre">lxml</span></code> uses C functions for file system access). It will <cite>not</cite>
use <code class="docutils literal notranslate"><span class="pre">lxml</span></code> however, if the environment variable <code class="docutils literal notranslate"><span class="pre">OPENPYXL_LXML</span></code> is set to
“False” (or anything other than “True”), so if you set this variable <cite>before</cite>
running the tests, it can work fine with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>.</p>
<p>If you encounter a module not working with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, and you are not sure
if the module can be handled or how to do it, please write a new issue. We
will check if it can be made to work, and at least add it to this list.</p>
</div>
</div>
<div class="section" id="pyfakefs-behaves-differently-than-the-real-filesystem">
<h2>Pyfakefs behaves differently than the real filesystem<a class="headerlink" href="#pyfakefs-behaves-differently-than-the-real-filesystem" title="Permalink to this headline">¶</a></h2>
<p>There are at least the following kinds of deviations from the actual behavior:</p>
<ul class="simple">
<li>unwanted deviations that we didn’t notice–if you find any of these, please
write an issue and we will try to fix it</li>
<li>behavior that depends on different OS versions and editions–as mentioned
in <a class="reference internal" href="intro.html#limitations"><span class="std std-ref">Limitations</span></a>, <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> uses the TravisCI systems as reference
system and will not replicate all system-specific behavior</li>
<li>behavior that depends on low-level OS functionality that <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> is not
able to emulate; examples are the <code class="docutils literal notranslate"><span class="pre">fcntl.ioctl</span></code> and <code class="docutils literal notranslate"><span class="pre">fcntl.fcntl</span></code>
functions that are patched to do nothing</li>
</ul>
</div>
<div class="section" id="the-test-code-tries-to-access-files-in-the-real-filesystem">
<h2>The test code tries to access files in the real filesystem<a class="headerlink" href="#the-test-code-tries-to-access-files-in-the-real-filesystem" title="Permalink to this headline">¶</a></h2>
<p>The loading of the actual Python code from the real filesystem does not use
the filesystem functions that <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> patches, but in some cases it may
access other files in the packages. An example is loading timezone information
from configuration files. In these cases, you have to map the respective files
or directories from the real into the fake filesystem as described in
<a class="reference internal" href="usage.html#real-fs-access"><span class="std std-ref">Access to files in the real file system</span></a>.</p>
</div>
<div class="section" id="os-temporary-directories">
<h2>OS temporary directories<a class="headerlink" href="#os-temporary-directories" title="Permalink to this headline">¶</a></h2>
<p>Tests relying on a completely empty file system on test start will fail.
As <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> does not fake the <code class="docutils literal notranslate"><span class="pre">tempfile</span></code> module (as described above),
a temporary directory is required to ensure that <code class="docutils literal notranslate"><span class="pre">tempfile</span></code> works correctly,
e.g., that <code class="docutils literal notranslate"><span class="pre">tempfile.gettempdir()</span></code> will return a valid value. This
means that any newly created fake file system will always have either a
directory named <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> when running on Linux or Unix systems,
<code class="docutils literal notranslate"><span class="pre">/var/folders/&lt;hash&gt;/T</span></code> when running on MacOs, or
<code class="docutils literal notranslate"><span class="pre">C:\Users\&lt;user&gt;\AppData\Local\Temp</span></code> on Windows:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="c1"># the temp directory is always present at test start</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="user-rights">
<h2>User rights<a class="headerlink" href="#user-rights" title="Permalink to this headline">¶</a></h2>
<p>If you run <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> tests as root (this happens by default if run in a
docker container), <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> also behaves as a root user, for example can
write to write-protected files. This may not be the expected behavior, and
can be changed.
<code class="docutils literal notranslate"><span class="pre">Pyfakefs</span></code> has a rudimentary concept of user rights, which differentiates
between root user (with the user id 0) and any other user. By default,
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> assumes the user id of the current user, but you can change
that using <code class="docutils literal notranslate"><span class="pre">fake_filesystem.set_uid()</span></code> in your setup. This allows to run
tests as non-root user in a root user environment and vice verse.
Another possibility to run tests as non-root user in a root user environment
is the convenience argument <a class="reference internal" href="usage.html#allow-root-user"><span class="std std-ref">allow_root_user</span></a>:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">SomeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">(</span><span class="n">allow_root_user</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="pyfakefs-and-mock-open">
<span id="usage-with-mock-open"></span><h2>Pyfakefs and mock_open<a class="headerlink" href="#pyfakefs-and-mock-open" title="Permalink to this headline">¶</a></h2>
<p>If you patch <code class="docutils literal notranslate"><span class="pre">open</span></code> using <code class="docutils literal notranslate"><span class="pre">mock_open</span></code> before the initialization of
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, it will not work properly, because the <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>
initialization relies on <code class="docutils literal notranslate"><span class="pre">open</span></code> working correctly.
Generally, you should not need <code class="docutils literal notranslate"><span class="pre">mock_open</span></code> if using <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, because you
always can create the files with the needed content using <code class="docutils literal notranslate"><span class="pre">create_file</span></code>.
This is true for patching any filesystem functions–avoid patching them
while working with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>.
If you still want to use <code class="docutils literal notranslate"><span class="pre">mock_open</span></code>, make sure it is only used while
patching is in progress. For example, if you are using <code class="docutils literal notranslate"><span class="pre">pytest</span></code> with the
<code class="docutils literal notranslate"><span class="pre">mocker</span></code> fixture used to patch <code class="docutils literal notranslate"><span class="pre">open</span></code>, make sure that the <code class="docutils literal notranslate"><span class="pre">fs</span></code> fixture is
passed before the <code class="docutils literal notranslate"><span class="pre">mocker</span></code> fixture to ensure this:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_mock_open_incorrect</span><span class="p">(</span><span class="n">mocker</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
    <span class="c1"># causes a recursion error</span>
    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mocker</span><span class="o">.</span><span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_mock_open_correct</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="c1"># works correctly</span>
    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mocker</span><span class="o">.</span><span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Troubleshooting</a><ul>
<li><a class="reference internal" href="#modules-not-working-with-pyfakefs">Modules not working with pyfakefs</a><ul>
<li><a class="reference internal" href="#multiprocessing-build-in">multiprocessing (build-in)</a></li>
<li><a class="reference internal" href="#subprocess-build-in">subprocess (build-in)</a></li>
<li><a class="reference internal" href="#modules-that-rely-on-subprocess-or-multiprocessing">Modules that rely on <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> or <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code></a></li>
<li><a class="reference internal" href="#the-pillow-imaging-library">The Pillow Imaging Library</a></li>
<li><a class="reference internal" href="#the-pandas-data-analysis-toolkit">The pandas data analysis toolkit</a></li>
<li><a class="reference internal" href="#xlrd">xlrd</a></li>
<li><a class="reference internal" href="#openpyxl">openpyxl</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pyfakefs-behaves-differently-than-the-real-filesystem">Pyfakefs behaves differently than the real filesystem</a></li>
<li><a class="reference internal" href="#the-test-code-tries-to-access-files-in-the-real-filesystem">The test code tries to access files in the real filesystem</a></li>
<li><a class="reference internal" href="#os-temporary-directories">OS temporary directories</a></li>
<li><a class="reference internal" href="#user-rights">User rights</a></li>
<li><a class="reference internal" href="#pyfakefs-and-mock-open">Pyfakefs and mock_open</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="usage.html"
                        title="previous chapter">Usage</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="autopatch.html"
                        title="next chapter">Automatically find and patch file functions and modules</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/troubleshooting.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="autopatch.html" title="Automatically find and patch file functions and modules"
             >next</a> |</li>
        <li class="right" >
          <a href="usage.html" title="Usage"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyfakefs 4.8.dev0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009 Google Inc. All Rights Reserved.
© Copyright 2014 Altera Corporation. All Rights Reserved.
© Copyright 2014-2022 John McGehee.
      Last updated on Sep 20, 2022.
    </div>
  </body>
</html>